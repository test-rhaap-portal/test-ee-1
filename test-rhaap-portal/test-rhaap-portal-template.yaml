---
apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: test-rhaap-portal
  title: test-rhaap-portal
  description: test
  annotations:
    ansible.io/saved-template: 'true'
  tags: ["execution-environment"]
spec:
  type: execution-environment

  parameters:
    # Step 1: Base Image Selection
    - title: Base Image
      description: Configure the base image for your execution environment
      properties:
        baseImage:
          title: Base execution environment image
          type: string
          default: 'registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.18'
          enum:
            - 'registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.18'
            - 'registry.redhat.io/ansible-automation-platform/ee-minimal-rhel9:2.18'
            - 'registry.redhat.io/ansible-automation-platform/ee-minimal-rhel8:2.16'
            - 'registry.redhat.io/ansible-automation-platform/ee-minimal-rhel9:2.16'
          enumNames:
            - 'Red Hat Ansible Minimal EE - Ansible Core 2.18 (RHEL 8)'
            - 'Red Hat Ansible Minimal EE - Ansible Core 2.18 (RHEL 9)'
            - 'Red Hat Ansible Minimal EE - Ansible Core 2.16 (RHEL 8)'
            - 'Red Hat Ansible Minimal EE - Ansible Core 2.16 (RHEL 9)'
          ui:field: BaseImagePicker
      dependencies:
        baseImage:
          oneOf:
            # Case 1: When "Custom Image" is selected
            - properties:
                baseImage:
                  const: 'custom'
                customBaseImage:
                  title: Custom Base Image
                  type: string
                  description: Enter a custom execution environment base image
                  ui:
                    field: EntityNamePicker
                    options:
                    allowArbitraryValues: true
                    help: 'Format: [registry[:port]/][namespace/]name[:tag]'
                    placeholder: 'e.g., quay.io/org/custom-ee:latest'
              required:
                - customBaseImage

            # Case 2: When any predefined base image is selected
            - properties:
                baseImage:
                  not:
                    const: 'custom'

    # Step 2: Ansible Collections
    - title: Collections
      description: Add collections to be included in your execution environment definition file (optional).
      properties:
        popularCollections:
          title: Add Popular Collections
          type: array
          items:
            type: string
            enum:
              - 'community.general'
              - 'ansible.posix'
              - 'ansible.windows'
              - 'ansible.utils'
              - 'amazon.aws'
              - 'azure.azcollection'
              - 'google.cloud'
              - 'amazon.ai'
              - 'cisco.ios'
              - 'cisco.nxos'
              - 'arista.eos'
              - 'cisco.iosxr'
          uniqueItems: true
          ui:widget: checkboxes
          ui:options:
            layout: horizontal
        collections:
          title: Ansible Collections
          type: array
          default: [{"name":"amazon.aws"},{"name":"amazon.ai"},{"name":"azure.azcollection"},{"name":"google.cloud"}]
          description: Add collections manually
          items:
            type: object
            properties:
              name:
                type: string
                title: Collection Name
                description: The name or source of the collection.
                ui:placeholder: 'e.g., amazon.aws, https://github.com/ansible-collections/cisco.ios'
              version:
                type: string
                title: Version (Optional)
                description: |
                  The version of the collection to install.
                  If not specified, the latest version will be installed.
                ui:placeholder: 'e.g., 7.2.1'
              source:
                type: string
                title: Source (Optional)
                description: |
                  The Galaxy URL to pull the collection from.
                  If type is 'file', 'dir', or 'subdirs', this should be a local path to the collection.
              type:
                type: string
                title: Type (Optional)
                description: Determines the source of the collection.
                enum:
                  - 'file'
                  - 'galaxy'
                  - 'git'
                  - 'url'
                  - 'dir'
                  - 'subdirs'
              signatures:
                type: array
                title: Signatures (Optional)
                description: |
                  A list of signature sources that are used to supplement those found on the Galaxy server during collection installation and ansible-galaxy collection verify.
                  Signature sources should be URIs that contain the detached signature.
                items:
                  type: string
                  title: Signature
                  description: URI of the signature file
          ui:field: CollectionsPicker
        collectionsFile:
          title: Upload a requirements.yml file
          description: Optionally upload a requirements file with collection details
          type: string
          format: data-url
          ui:field: FileUploadPicker
        specifyRequirements:
          title: Specify additional Python requirements and System packages
          type: boolean
          default: false
          ui:help: "Check this box to define additional Python or system dependencies to include in your EE."
      dependencies:
        specifyRequirements:
          oneOf:
            - properties:
                specifyRequirements:
                  const: true
                pythonRequirements:
                  title: Additional Python Requirements
                  type: array
                  default: []
                  description: |
                    Specify additional python packages that are required in addition to what the selected collections already specify as dependencies.
                    Packages already specified in the collections as a dependency should not be repeated here.
                  items:
                    type: string
                    title: Python package
                    description: Python package (with optional version specification)
                    ui:placeholder: 'e.g., requests>=2.28.0'
                  ui:field: PackagesPicker
                pythonRequirementsFile:
                  type: string
                  format: data-url
                  title: Pick a file with Python requirements
                  description: Upload a requirements.txt file with python package details
                  ui:field: FileUploadPicker
                systemPackages:
                  title: Additional System Packages
                  type: array
                  default: []
                  description: |
                    Specify additional system-level packages that are required in addition to what the selected collections already specify as dependencies.
                    Packages already specified in the collections as a dependency should not be repeated here.
                  items:
                    type: string
                    title: System package
                    description: System package
                    ui:placeholder: 'e.g., libxml2-dev [platform:dpkg], libssh-devel [platform:rpm]'
                  ui:field: PackagesPicker
                systemPackagesFile:
                  type: string
                  format: data-url
                  title: Pick a file with system packages
                  description: Upload a bindep.txt file with system package details
                  ui:field: FileUploadPicker
            - properties:
                specifyRequirements:
                  const: false

    # Step 3: MCP servers
    - title: MCP servers
      description: Add MCP servers to be installed in the execution environment definition file (optional).
      properties:
        mcpServers:
          title: MCP Servers
          type: array
          default: []
          items:
            type: string
            title: MCP Server
            enum:
              - aws_ccapi_mcp
              - aws_cdk_mcp
              - aws_core_mcp
              - aws_iam_mcp
              - azure_mcp
              - github_mcp
            enumNames:
              - AWS CCAPI
              - AWS CDK
              - AWS Core
              - AWS IAM
              - Azure
              - GitHub
          ui:field: MCPServersPicker

    # Step 4: Additional Build Steps
    - title: Additional Build Steps
      description: Add custom build steps that will be executed at specific points during the build process. These map to ansible-builder's additional_build_steps configuration.
      properties:
        additionalBuildSteps:
          title: Additional Build Steps
          type: array
          default: [{"stepType":"prepend_base","commands":["COPY _build/configs/ansible.cfg /etc/ansible/ansible.cfg"]},{"stepType":"append_final","commands":["RUN rm -f /etc/ansible/ansible.cfg"]}]
          items:
            type: object
            properties:
              stepType:
                title: Step Type
                type: string
                description: When this build step should execute
                enum:
                  - 'prepend_base'
                  - 'append_base'
                  - 'prepend_galaxy'
                  - 'append_galaxy'
                  - 'prepend_builder'
                  - 'append_builder'
                  - 'prepend_final'
                  - 'append_final'
                enumNames:
                  - 'Prepend Base - Before base image dependencies'
                  - 'Append Base - After base image dependencies'
                  - 'Prepend Galaxy - Before Ansible collections'
                  - 'Append Galaxy - After Ansible collections'
                  - 'Prepend Builder - Before main build steps'
                  - 'Append Builder - After main build steps'
                  - 'Prepend Final - Before final image steps'
                  - 'Append Final - After final image steps'
                default: 'prepend_base'
              commands:
                title: Commands
                type: array
                description: List of commands to execute
                items:
                  type: string
            required: ['stepType', 'commands']
          ui:field: AdditionalBuildStepsPicker

    # Step 9: Repository Configuration
    - title: Generate and publish
      description: Generate and publish the EE definition file and template.
      properties:
        eeFileName:
          title: EE File Name
          type: string
          description: Name of the Execution Environment file.
          ui:field: EEFileNamePicker
          ui:help: "Specify the filename for the Execution Environment definition file."
        templateDescription:
          title: Description
          type: string
          description: |
            Description for the generated Execution Environment definition.
            This description is used when displaying the Execution Environment definition in the catalog.
            Additionally, this description is also used in the Software Template that is generated with SCM-based publishing.
        tags:
          title: Tags
          description: |
            Add tags to make this EE definition discoverable in the catalog.
            The default execution-environment tag identifies this as an EE component; keeping it is highly recommended
          type: array
          default:
            - 'execution-environment'
          items:
            type: string
          ui:
            options:
              addable: true
              orderable: true
              removable: true
            help: "Add one or more tags for the generated template."
        publishToSCM:
          title: Publish to a Git repository
          description: Publish the EE definition file and template to a Git repository.
          type: boolean
          default: true
          ui:help: "If unchecked, the EE definition file and template will not be pushed to a Git repository. Regardless of your selection, you will get a link to download the files locally."
      required:
        - eeFileName
        - templateDescription
      dependencies:
        publishToSCM:
          oneOf:
            - properties:
                publishToSCM:
                  const: true
                sourceControlProvider:
                  title: Select source control provider
                  description: Choose your source control provider
                  type: string
                  enum:
                    - Github
                    - Gitlab
                  ui:
                    component: select
                    help: Select the source control provider to publish the EE definition files to.
                repositoryOwner:
                  title: Git repository organization or username
                  type: string
                  description: The organization or username that owns the Git repository.
                repositoryName:
                  title: Repository Name
                  type: string
                  description: Specify the name of the repository where the EE definition files will be published.
                createNewRepository:
                  title: Create new repository
                  type: boolean
                  description: Create a new repository, if the specified one does not exist.
                  default: false
                  ui:help: "If unchecked, a new repository will not be created if the specified one does not exist. The generated files will not be published to a repository."
              required:
                - sourceControlProvider
                - repositoryOwner
                - repositoryName
                - createNewRepository
            - properties:
                publishToSCM:
                  const: false

  steps:
    # Step 1: Create EE definition files
    - id: create-ee-definition
      name: Create Execution Environment Definition
      action: ansible:create:ee-definition
      input:
        values:
          eeFileName: ${{ parameters.eeFileName }}
          eeDescription: ${{ parameters.templateDescription }}
          tags: ${{ parameters.tags or [] }}
          publishToSCM: ${{ parameters.publishToSCM }}
          baseImage: ${{ parameters.baseImage === 'custom' and parameters.customBaseImage or parameters.baseImage }}
          customBaseImage: ${{ parameters.customBaseImage or '' }}
          popularCollections: ${{ parameters.popularCollections or [] }}
          collections: ${{ parameters.collections or [] }}
          collectionsFile: ${{ parameters.collectionsFile or [] }}
          pythonRequirements: ${{ parameters.pythonRequirements or [] }}
          pythonRequirementsFile: ${{ parameters.pythonRequirementsFile or [] }}
          systemPackages: ${{ parameters.systemPackages or [] }}
          systemPackagesFile: ${{ parameters.systemPackagesFile or [] }}
          mcpServers: ${{ parameters.mcpServers or [] }}
          additionalBuildSteps: ${{ parameters.additionalBuildSteps or [] }}

    # Step 3: Validate the SCM repository (optional)
    - id: prepare-publish
      action: ansible:prepare:publish
      name: Prepare for publishing
      if: ${{ parameters.publishToSCM }}
      input:
        sourceControlProvider: ${{ parameters.sourceControlProvider }}
        repositoryOwner: ${{ parameters.repositoryOwner }}
        repositoryName: ${{ parameters.repositoryName }}
        createNewRepository: ${{ parameters.createNewRepository }}
        eeFileName: ${{ parameters.eeFileName }}
        contextDirName: ${{ steps['create-ee-definition'].output.contextDirName }}

    - id: create-catalog-info-file
      action: catalog:write
      if: ${{ parameters.publishToSCM }}
      name: Create catalog component file for the EE Definition
      input:
        filePath: ${{ steps['create-ee-definition'].output.catalogInfoPath }}
        entity:
          apiVersion: backstage.io/v1alpha1
          kind: Component
          metadata:
            name: ${{ parameters.eeFileName }}
            description: ${{ parameters.templateDescription }}
            tags: ${{ parameters.tags or [] }}
            annotations:
              backstage.io/techdocs-ref: dir:.
              backstage.io/managed-by-location: ${{ steps['prepare-publish'].output.generatedRepoUrl }}
              ansible.io/scm-provider: ${{ parameters.sourceControlProvider }}
          spec:
            type: execution-environment
            owner: ${{ steps['create-ee-definition'].output.owner }}
            lifecycle: production

    # Step 5: Create and publish to a new GitHub Repository
    - id: publish-github
      name: Create and publish to a new GitHub Repository
      action: publish:github
      if: ${{ (parameters.publishToSCM) and (steps['prepare-publish'].output.createNewRepo) and (parameters.sourceControlProvider == 'Github') }}
      input:
        description: ${{ parameters.templateDescription }}
        repoUrl: ${{ steps['prepare-publish'].output.generatedRepoUrl }}
        defaultBranch: 'main'
        repoVisibility: 'public'

    # Step 5: Create and publish to a new Gitlab Repository
    - id: publish-gitlab
      name: Create and publish to a new GitLab Repository
      action: publish:gitlab
      if: ${{ (parameters.publishToSCM) and (steps['prepare-publish'].output.createNewRepo) and parameters.sourceControlProvider == 'Gitlab' }}
      input:
        repoUrl: ${{ steps['prepare-publish'].output.generatedRepoUrl }}
        defaultBranch: 'main'
        repoVisibility: 'public'

    # Step 5: Publish generated files as a Github Pull Request
    - id: publish-github-pull-request
      name: Publish generated files as a Github Pull Request
      action: publish:github:pull-request
      if: ${{ parameters.publishToSCM and (not steps['prepare-publish'].output.createNewRepo) and (parameters.sourceControlProvider == 'Github') }}
      input:
        repoUrl: ${{ steps['prepare-publish'].output.generatedRepoUrl }}
        branchName: ${{ steps['prepare-publish'].output.generatedBranchName }}
        title: ${{ steps['prepare-publish'].output.generatedTitle }}
        description: ${{ steps['prepare-publish'].output.generatedDescription }}

    # Step 5: Publish generated files as a Gitlab Merge Request
    - id: publish-gitlab-merge-request
      name: Publish generated files as a Gitlab Merge Request
      action: publish:gitlab:merge-request
      if: ${{ parameters.publishToSCM and (not steps['prepare-publish'].output.createNewRepo) and (parameters.sourceControlProvider == 'Gitlab') }}
      input:
        repoUrl: ${{ steps['prepare-publish'].output.generatedRepoUrl }}
        branchName: ${{ steps['prepare-publish'].output.generatedBranchName }}
        title: ${{ steps['prepare-publish'].output.generatedTitle }}
        description: ${{ steps['prepare-publish'].output.generatedDescription }}

    - id: register-catalog-component
      name: Register published EE as a Catalog Component
      action: catalog:register
      if: ${{ parameters.publishToSCM }}
      input:
        catalogInfoUrl: ${{ steps['prepare-publish'].output.generatedCatalogInfoUrl }}
        optional: true

  output:
    text:
      - title: Next Steps
        content: |
          ${{ steps['create-ee-definition'].output.readmeContent }}
    links:
      - title: ${{ parameters.sourceControlProvider }} Repository
        url: ${{ steps['prepare-publish'].output.generatedFullRepoUrl }}
        if: ${{ (parameters.publishToSCM) and (steps['prepare-publish'].output.createNewRepo) }}
        icon: ${{ parameters.sourceControlProvider | lower }}

      - title: GitHub Pull Request
        url: ${{ steps['publish-github-pull-request'].output.remoteUrl }}
        if: ${{ (parameters.publishToSCM) and (not steps['prepare-publish'].output.createNewRepo) and (parameters.sourceControlProvider == 'Github') }}
        icon: github

      - title: GitLab Merge Request
        url: ${{ steps['publish-gitlab-merge-request'].output.mergeRequestUrl  }}
        if: ${{ (parameters.publishToSCM) and (not steps['prepare-publish'].output.createNewRepo) and (parameters.sourceControlProvider == 'Gitlab') }}

      - title: View details in catalog
        icon: catalog
        url: ${{ steps['create-ee-definition'].output.generatedEntityRef }}
        if: ${{ not (steps['publish-github-pull-request'].output.remoteUrl or steps['publish-gitlab-merge-request'].output.mergeRequestUrl) }}
